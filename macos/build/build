#!/bin/sh

# Copyright (c) 2013-2022, The PurpleI2P Project
# This file is part of Purple I2P project and licensed under BSD3
# See full license text in LICENSE file at top of project tree

dir=${0%/*}
if [ "$dir" = "$0" ]; then
  dir="."
fi
cd $dir

version="32.5"
i2pdversion="2.43.0"
mpprefix="/opt/local"
sourceforgemirror="https://sourceforge.net/projects/tenfourfox/files"

curlfind=$(which curl)
if [ -z $curlfind ]; then
	echo "'cURL' does not seem to be installed. The script needs it!"
	exit 1
fi

echo "This script is preparing TenFourFox $version for use with I2Pd"

file="TenFourFoxG5-FPR${version}.app.zip"
filepath="fpr${version}/${file}"

echo "Downloading TenFourFox..."

tmpfilepath=$(echo $filepath)
curl -L -f -# -o "${file}" "${sourceforgemirror}/${tmpfilepath}"
if [ $? -ne 0 ]; then # Not found error
	echo "[Error] Can't download file. Check your internet connectivity."
	exit 1
fi

if [ ! -f "$file" ]; then
	echo "[Error] Can't find downloaded file. Does it really exist?"
	exit 1
fi

echo "Extracting files..."
unzip "$file" -d ../
mkdir ../data

echo "Removing archive file..."
rm "$file"

# Deleting some not needed files
rm ../TenFourFoxG5.app/Contents/Resources/update*
# This file not used in TFF:
# sed -i '' -e "s/Enabled=1/Enabled=0/g" "../FirefoxESR.app/Contents/Resources/application.ini"
# sed -i '' -e "s/ServerURL=.*/ServerURL=-/" "../FirefoxESR.app/Contents/Resources/application.ini"
# Done!

echo "Downloading language packs..."
# Already exists:
mkdir ../TenFourFoxG5.app/Contents/Resources/browser/extensions
curl -L -f -# -o ../TenFourFoxG5.app/Contents/Resources/browser/extensions/langpack-en-US@firefox.mozilla.org.xpi https://addons.mozilla.org/firefox/downloads/file/3971625/english_us_language_pack-102.0.1buildid20220705.093820.xpi
curl -L -f -# -o ../TenFourFoxG5.app/Contents/Resources/browser/extensions/en-US@dictionaries.addons.mozilla.org.xpi https://addons.mozilla.org/firefox/downloads/file/3893473/us_english_dictionary-91.0.xpi

echo "Downloading NoScript extension..."
curl -L -f -# -o ../TenFourFoxG5.app/Contents/Resources/browser/extensions/{73a6fe31-595d-460b-a920-fcc0f8843232}.xpi https://addons.mozilla.org/firefox/downloads/file/4002416/noscript-11.4.11.xpi

echo "Adding standard configs..."
cp -r preferences/* ../TenFourFoxG5.app/Contents/Resources/
cp -r profile/* ../data/
cp -r profile-en/* ../data/

echo '#!/bin/sh' > "../i2pdbrowser-portable"
echo 'dir=${0%/*}' >> "../i2pdbrowser-portable"
echo 'if [ "$dir" = "$0" ]; then' >> "../i2pdbrowser-portable"
echo '  dir="."' >> "../i2pdbrowser-portable"
echo 'fi' >> "../i2pdbrowser-portable"
echo 'cd $dir' >> "../i2pdbrowser-portable"
echo 'TenFourFoxG5.app/Contents/MacOS/firefox -profile data -no-remote' >> "../i2pdbrowser-portable"

chmod +x "../i2pdbrowser-portable"

echo "Linking i2pd..."

if [ ! -f "${mpprefix}/bin/i2pd" ]; then
	echo "[Error] Can't find i2pd in MacPorts prefix. Please make sure it is installed."
	exit 1
fi

mkdir ../i2pd
cp -rf i2pd/* ../i2pd
chmod +x "../i2pd/i2pd"

echo "... finished"
